name: CI - EAS Build (Android)

on:
  push:
    branches: [ main ]
    paths:
      - 'ONJI/**'
  pull_request:
    paths:
      - 'ONJI/**'
  workflow_dispatch: {}

jobs:
  build-android:
    name: Build Android (EAS)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ONJI

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Cache node modules (ONJI)
        uses: actions/cache@v4
        with:
          path: ONJI/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('ONJI/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Expo / EAS login
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          npx eas whoami || npx eas login --token "$EXPO_TOKEN"

      - name: Run EAS Android build
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          npx eas build --platform android --profile production --non-interactive

      # âœ… NEW STEP â€” Send APK link via email
      - name: Send APK download link via email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "ONJI Android APK Build Ready ðŸš€"
          to: hasthikdjathan644@gmail.com
          from: GitHub CI
          body: |
            Your Expo Android build is ready.

            Download APK here:
            https://expo.dev/artifacts/eas/w35h849RnBzUfoP33dikcW.apk

            Triggered from GitHub Actions.

