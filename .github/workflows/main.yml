name: CI - EAS Build (Android)

on:
  push:
    branches:
      - main
    paths:
      - 'ONJI/**'

jobs:
  build-android:
    name: Build Android (EAS)
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ONJI

    steps:
      # -----------------------------
      # Checkout
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # Node setup
      # -----------------------------
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      # -----------------------------
      # Cache dependencies
      # -----------------------------
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ONJI/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('ONJI/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # -----------------------------
      # Install deps
      # -----------------------------
      - name: Install dependencies
        run: npm ci

      # -----------------------------
      # Install EAS CLI
      # -----------------------------
      - name: Install EAS CLI
        run: npm install -g eas-cli

      # -----------------------------
      # Expo login
      # -----------------------------
      - name: Expo login
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          npx eas whoami || npx eas login --token "$EXPO_TOKEN"

      # -----------------------------
      # Build + extract APK URL
      # -----------------------------
      - name: Run EAS Android build and extract APK URL
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          BUILD_JSON=$(npx eas build \
            --platform android \
            --profile production \
            --non-interactive \
            --json)

          echo "$BUILD_JSON" > build.json

          APK_URL=$(jq -r '.[0].artifacts.applicationArchiveUrl' build.json)

          if [ -z "$APK_URL" ] || [ "$APK_URL" = "null" ]; then
            echo "Failed to extract APK URL"
            exit 1
          fi

          echo "APK_URL=$APK_URL" >> $GITHUB_ENV
          echo "APK URL: $APK_URL"

      # -----------------------------
      # Send email
      # -----------------------------
      - name: Send APK download link via email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "ONJI Android APK Build Ready ðŸš€"
          to: hasthikdjathan644@gmail.com
          from: GitHub CI
          body: |
            Your Expo Android build is ready.

            Download APK:
            ${{ env.APK_URL }}

            Commit: ${{ github.sha }}
