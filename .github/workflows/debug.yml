name: CI - EAS Build & Firebase App Distribution

on:
  push:
    branches:
      - main
      - 'release/*'
  workflow_dispatch:

jobs:
  build-and-distribute:
    runs-on: ubuntu-latest

    # Provide job-level env so all steps see EXPO_TOKEN and other secrets
    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      EAS_PROFILE: ${{ secrets.EAS_BUILD_PROFILE || 'preview' }}
      FIREBASE_SA_B64: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

    # Default working directory for run steps is ONJI (your frontend folder)
    defaults:
      run:
        working-directory: ONJI

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # System-level installs should run at repo root
      - name: Install system deps
        run: sudo apt-get update && sudo apt-get install -y openjdk-11-jdk unzip
        working-directory: .

      # Install the modern expo CLI (package name "expo"), eas-cli and firebase-tools globally at repo root
      - name: Install global CLIs (expo, eas-cli, firebase-tools)
        run: npm install -g expo eas-cli firebase-tools
        working-directory: .

      # Install JS deps inside ONJI (defaults apply)
      - name: Install JS deps
        run: npm ci

      # Note: We do NOT run `expo login --token` in CI. EAS/expo will use EXPO_TOKEN from env.
      # EAS Build Android
      - name: EAS Build Android
        if: always()
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -o pipefail
          eas build --platform android --profile $EAS_PROFILE --non-interactive --output json > eas_android.json
          node -e "const fs=require('fs'); const o=JSON.parse(fs.readFileSync('eas_android.json')); const url=(o.artifacts && o.artifacts.buildUrl)||o.artifactUrl||o.downloadUrl; if(!url){console.error('no url'); process.exit(1);} console.log(url);" > android_url.txt
          curl -L -o android_build.aab $(cat android_url.txt)

      # EAS Build iOS (optional)
      - name: EAS Build iOS (optional)
        if: always()
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -o pipefail
          eas build --platform ios --profile $EAS_PROFILE --non-interactive --output json > eas_ios.json || true
          if [ -s eas_ios.json ]; then
            node -e "const fs=require('fs'); const o=JSON.parse(fs.readFileSync('eas_ios.json')); const url=(o.artifacts && o.artifacts.buildUrl)||o.artifactUrl||o.downloadUrl; if(url) console.log(url);" > ios_url.txt || true
            if [ -s ios_url.txt ]; then curl -L -o ios_build.ipa $(cat ios_url.txt); fi
          fi

      # Decode firebase service account at repo root so /tmp path is reliable
      - name: Decode Firebase service account
        run: |
          echo "$FIREBASE_SA_B64" | base64 --decode > /tmp/firebase_sa.json
        env:
          FIREBASE_SA_B64: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        working-directory: .

      # Ensure firebase-tools is present and GOOGLE_APPLICATION_CREDENTIALS is set (run at repo root)
      - name: Install Firebase CLI and auth
        run: |
          npm i -g firebase-tools
          if [ ! -f /tmp/firebase_sa.json ]; then
            echo "ERROR: /tmp/firebase_sa.json not found"
            exit 1
          fi
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase_sa.json
          echo "Firebase service account present at /tmp/firebase_sa.json"
        env:
          FIREBASE_SA_B64: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        working-directory: .

      # Distribute Android to Firebase App Distribution (runs from ONJI by default)
      - name: Distribute Android to Firebase App Distribution
        if: always()
        env:
          FIREBASE_APP_ID_ANDROID: ${{ secrets.FIREBASE_APP_ID_ANDROID }}
        run: |
          if [ -f android_build.aab ]; then
            echo "Found android_build.aab — uploading to Firebase App Distribution"
            export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase_sa.json
            npx firebase appdistribution:distribute android_build.aab \
              --app "${{ secrets.FIREBASE_APP_ID_ANDROID }}" \
              --release-notes "CI build $GITHUB_SHA" \
              --tester-emails "${{ secrets.FIREBASE_TESTERS }}"
          else
            echo "android_build.aab not found — skipping Android distribution"
          fi

      # Distribute iOS to Firebase App Distribution (runs from ONJI by default)
      - name: Distribute iOS to Firebase App Distribution
        if: always()
        env:
          FIREBASE_APP_ID_IOS: ${{ secrets.FIREBASE_APP_ID_IOS }}
        run: |
          if [ -f ios_build.ipa ]; then
            echo "Found ios_build.ipa — uploading to Firebase App Distribution"
            export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase_sa.json
            npx firebase appdistribution:distribute ios_build.ipa \
              --app "${{ secrets.FIREBASE_APP_ID_IOS }}" \
              --release-notes "CI build $GITHUB_SHA" \
              --tester-emails "${{ secrets.FIREBASE_TESTERS }}"
          else
            echo "ios_build.ipa not found — skipping iOS distribution"
          fi
